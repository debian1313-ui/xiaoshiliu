# 视频转码增强功能说明

## 概述

本次更新为视频转码系统添加了智能分辨率选择和原始画质选项，确保视频在转码过程中保持宽高比，不会产生画面变形。

## 主要功能

### 1. 原始视频画质选项

- **新增"原始"画质选项**：保持原始分辨率，但进行压缩以节省带宽
- **可配置码率**：通过 `.env` 文件中的 `ORIGINAL_VIDEO_MAX_BITRATE` 配置（默认 8000kbps）
- **自动包含**：系统会自动为所有视频生成原始画质选项

### 2. 智能宽高比保持

系统会自动根据源视频的宽高比等比例缩放目标分辨率，确保画面不变形。

#### 示例对比

**横屏视频 (16:9 - 1920x1080)**
```
源视频: 1920x1080
转码结果:
  - 原始: 1920x1080 @ 8000kbps (压缩)
  - 720p:  1280x720  @ 2500kbps ✅ 保持 16:9 比例
  - 480p:  854x480   @ 1000kbps ✅ 保持 16:9 比例
  - 360p:  640x360   @ 750kbps  ✅ 保持 16:9 比例
```

**竖屏视频 (9:16 - 720x1280)**
```
源视频: 720x1280
转码结果:
  - 原始:  720x1280 @ 8000kbps (压缩)
  - 1080p: 608x1080 @ 5000kbps ✅ 保持 9:16 比例
  - 720p:  406x720  @ 2500kbps ✅ 保持 9:16 比例
  - 480p:  270x480  @ 1000kbps ✅ 保持 9:16 比例
  - 360p:  204x360  @ 750kbps  ✅ 保持 9:16 比例，而不是 640x360 (会变形)
```

**4K视频 (16:9 - 3840x2160)**
```
源视频: 3840x2160
转码结果:
  - 原始:  3840x2160 @ 8000kbps (压缩)
  - 1080p: 1920x1080 @ 5000kbps ✅
  - 720p:  1280x720  @ 2500kbps ✅
  - 480p:  854x480   @ 1000kbps ✅
  - 360p:  640x360   @ 750kbps  ✅
```

### 3. 灵活的分辨率支持

- **支持非标准分辨率**：自动识别并处理各种宽高比（16:9、9:16、4:3、21:9 等）
- **至少 4 个码率选项**：360p、480p、720p、1080p（根据源视频分辨率）
- **智能跳过**：不会转码到高于原视频的分辨率
  - 例如：720p 视频不会转码为 1080p
  - 例如：360p 视频只保留原始画质

### 4. H.264 编码兼容性

- 自动调整宽高为偶数（H.264 编码要求）
- 确保所有转码视频都能在各种播放器中正常播放

## 配置说明

### 环境变量配置

在 `express-project/.env` 文件中添加以下配置：

```bash
# 原始视频最大码率 (kbps)
# 这将提供一个"原始"画质选项，保持原始分辨率但进行压缩
ORIGINAL_VIDEO_MAX_BITRATE=8000

# DASH分片时长（秒）
DASH_SEGMENT_DURATION=4

# 最小码率 (kbps)
DASH_MIN_BITRATE=500

# 最大码率 (kbps)
DASH_MAX_BITRATE=5000

# 支持的分辨率列表（逗号分隔）
# 系统会自动根据视频宽高比等比例缩放
DASH_RESOLUTIONS=1920x1080:5000,1280x720:2500,854x480:1000,640x360:750
```

### 配置说明

- `ORIGINAL_VIDEO_MAX_BITRATE`: 原始画质的最大码率，建议 6000-10000 之间
- `DASH_RESOLUTIONS`: 标准分辨率配置，系统会根据源视频自动调整实际输出尺寸
- 所有转码都会自动保持源视频的宽高比

## 技术实现

### 核心函数

1. **`calculateAspectRatioSize()`**: 计算保持宽高比的缩放尺寸
   - 输入：源视频宽高、目标高度
   - 输出：缩放后的宽度和高度（偶数）

2. **`selectResolutions()`**: 智能选择适合的转码分辨率
   - 自动跳过高于源视频的分辨率
   - 为每个目标高度计算等比例缩放的宽度
   - 添加原始画质选项

### 代码示例

```javascript
// 计算保持宽高比的尺寸
const scaledSize = calculateAspectRatioSize(720, 1280, 360);
// 结果: { width: 204, height: 360 }

// 选择转码分辨率
const resolutions = selectResolutions(1920, 1080, configResolutions, {
  includeOriginal: true,
  originalMaxBitrate: 8000
});
// 结果: [
//   { width: 1920, height: 1080, bitrate: 8000, label: '原始', isOriginal: true },
//   { width: 1280, height: 720, bitrate: 2500, label: '720p' },
//   { width: 854, height: 480, bitrate: 1000, label: '480p' },
//   { width: 640, height: 360, bitrate: 750, label: '360p' }
// ]
```

## 测试结果

所有测试通过 ✅

- ✅ 16:9 横屏视频保持宽高比
- ✅ 9:16 竖屏视频保持宽高比（避免变形）
- ✅ 4:3 标准视频保持宽高比
- ✅ 原始画质选项正确生成
- ✅ 至少生成 4 个画质选项
- ✅ 不会向上转码
- ✅ H.264 兼容性（偶数宽高）

## 用户体验

### 前端播放器

- 播放器会自动检测可用的画质选项
- 显示"原始"、"自动"、"1080p"、"720p"等选项
- 用户可以手动切换画质或使用自动模式

### 优势

1. **无画面变形**：所有分辨率都保持原始宽高比
2. **更好的画质**：原始画质选项提供最高质量
3. **灵活性**：支持各种非标准分辨率和宽高比
4. **节省带宽**：多码率自适应播放
5. **广泛兼容**：支持横屏、竖屏、方形等各种视频

## 升级指南

1. 更新 `.env` 文件，添加 `ORIGINAL_VIDEO_MAX_BITRATE` 配置
2. 重启应用
3. 新上传的视频会自动使用新的转码逻辑
4. 已有视频不受影响（可选择性重新转码）

## 注意事项

- 原始画质选项会占用更多存储空间（但提供最佳画质）
- 低分辨率视频（如 360p 以下）可能只有原始画质选项
- 转码时间取决于视频大小和服务器性能
- 建议定期清理未使用的视频文件

## 相关文档

- [视频转码配置文档](../doc/API_DOCS.md)
- [部署指南](../doc/DEPLOYMENT.md)
- [项目结构](../doc/PROJECT_STRUCTURE.md)
